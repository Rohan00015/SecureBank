{% extends "layout.html" %}

{% block extra_styles %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center pb-4 border-b border-gray-800">
        <h1 class="text-3xl font-bold text-white">Profile Settings</h1>
        <a href="{{ url_for('dashboard') }}" class="px-4 py-2 rounded-lg bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700 transition-colors text-sm font-medium">Back to Dashboard</a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="lg:col-span-4 space-y-6">
            <div class="glass-card rounded-2xl p-6 text-center relative overflow-hidden group">
                <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-blue-900/50 to-purple-900/50"></div>
                
                <div class="relative inline-block mt-8 mb-4">
                    <img src="{{ user.profile_picture_url }}?v={{ range(1, 1000) | random }}" id="avatar-preview"
                         class="w-32 h-32 rounded-full border-4 border-[#0f172a] object-cover relative z-10 shadow-xl bg-gray-800">
                    <label for="profile_picture" class="absolute bottom-1 right-1 bg-blue-600 hover:bg-blue-500 text-white p-2 rounded-full cursor-pointer z-20 shadow-lg border-2 border-[#0f172a] transition-transform hover:scale-110">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </label>
                    <input type="file" name="profile_picture" id="profile_picture" class="hidden" accept="image/*">
                </div>
                
                <h2 class="text-xl font-bold text-white">{{ user.full_name or 'SecureBank User' }}</h2>
                <p class="text-blue-400 text-sm mb-4">{{ user.email }}</p>
                <div class="flex justify-center gap-2">
                    <span class="px-3 py-1 bg-green-500/10 text-green-400 border border-green-500/20 rounded-full text-xs font-medium">Active</span>
                </div>
            </div>

            <div class="glass-card rounded-2xl p-6 border-l-4 border-l-amber-500">
                <h3 class="font-bold text-white mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    Transaction PIN
                </h3>
                <form action="{{ url_for('set_mpin') }}" method="POST" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="password" name="mpin" placeholder="New PIN" maxlength="4" inputmode="numeric" required
                               class="w-full px-3 py-2 bg-gray-900/50 border border-gray-600 rounded-lg text-center tracking-[0.3em] text-white focus:ring-2 focus:ring-amber-500">
                        <input type="password" name="confirm_mpin" placeholder="Confirm" maxlength="4" inputmode="numeric" required
                               class="w-full px-3 py-2 bg-gray-900/50 border border-gray-600 rounded-lg text-center tracking-[0.3em] text-white focus:ring-2 focus:ring-amber-500">
                    </div>
                    <button type="submit" class="w-full py-2 bg-amber-600 hover:bg-amber-500 text-white rounded-lg font-bold text-sm transition-colors shadow-lg">
                        {{ 'Update MPIN' if user.mpin_hash else 'Set MPIN' }}
                    </button>
                </form>
            </div>
        </div>

        <div class="lg:col-span-8 space-y-6">
            <div class="glass-card rounded-2xl p-8">
                <h3 class="text-xl font-bold text-white mb-6 pb-2 border-b border-gray-700">Personal Information</h3>
                <form action="{{ url_for('update_profile') }}" method="POST" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Full Name</label>
                        <input type="text" name="full_name" value="{{ user.full_name or '' }}" class="w-full px-4 py-2 glass-input rounded-lg">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Date of Birth</label>
                        <input type="date" name="dob" value="{{ user.dob or '' }}" class="w-full px-4 py-2 glass-input rounded-lg">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Phone</label>
                        <input type="tel" name="phone_number" value="{{ user.phone_number or '' }}" class="w-full px-4 py-2 glass-input rounded-lg">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Address</label>
                        <textarea name="address" rows="2" class="w-full px-4 py-2 glass-input rounded-lg">{{ user.address or '' }}</textarea>
                    </div>
                    <div class="md:col-span-2 text-right">
                        <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold shadow-lg transition-transform hover:-translate-y-1">Save Changes</button>
                    </div>
                </form>
            </div>

            <div class="glass-card rounded-2xl p-8">
                <h3 class="text-xl font-bold text-white mb-6 pb-2 border-b border-gray-700">Change Password</h3>
                <form action="{{ url_for('change_password') }}" method="POST" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="password" name="current_password" placeholder="Current Password" required class="w-full px-4 py-2 glass-input rounded-lg">
                    <input type="password" name="new_password" placeholder="New Password" required class="w-full px-4 py-2 glass-input rounded-lg">
                    <input type="password" name="confirm_password" placeholder="Confirm New" required class="w-full px-4 py-2 glass-input rounded-lg">
                    <div class="md:col-span-3 text-right mt-2">
                        <button type="submit" class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-bold shadow-lg transition-colors">Update Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="cropModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
    <div class="glass-card bg-gray-900 border border-gray-700 rounded-2xl max-w-lg w-full overflow-hidden">
        <div class="p-4 border-b border-gray-700"><h3 class="text-white font-bold">Crop Image</h3></div>
        <div class="p-4 h-80 bg-black"><img id="imageToCrop" src="" class="max-h-full mx-auto"></div>
        <div class="p-4 border-t border-gray-700 flex justify-end gap-3">
            <button id="cancelCrop" class="px-4 py-2 text-gray-300 hover:text-white font-medium">Cancel</button>
            <button id="confirmCrop" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold">Save</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
    const input = document.getElementById('profile_picture');
    const modal = document.getElementById('cropModal');
    const image = document.getElementById('imageToCrop');
    let cropper;

    input.addEventListener('change', (e) => {
        const files = e.target.files;
        if (files && files.length > 0) {
            const reader = new FileReader();
            reader.onload = () => {
                image.src = reader.result;
                modal.classList.remove('hidden');
                if(cropper) cropper.destroy();
                cropper = new Cropper(image, { aspectRatio: 1, viewMode: 1 });
            };
            reader.readAsDataURL(files[0]);
        }
    });

    document.getElementById('cancelCrop').addEventListener('click', () => { modal.classList.add('hidden'); input.value = ''; });
    document.getElementById('confirmCrop').addEventListener('click', () => {
        if (!cropper) return;
        cropper.getCroppedCanvas({ width: 300, height: 300 }).toBlob((blob) => {
            const formData = new FormData();
            formData.append('croppedImage', blob, `p_${Date.now()}.jpg`);
            fetch("{{ url_for('update_profile_picture') }}", { method: 'POST', body: formData })
            .then(r => { if(r.ok) window.location.reload(); else alert('Error uploading'); });
        }, 'image/jpeg');
    });
</script>
{% endblock %}