{% extends "layout.html" %}

{% block extra_styles %}
<style>
    /* Smooth entry animation */
    .fade-up { animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Input focus glow */
    .glass-input:focus {
        background: rgba(0, 0, 0, 0.6);
        border-color: #3b82f6; /* Blue-500 */
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="flex items-center justify-center min-h-[80vh] p-4 relative fade-up">
    
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-lg h-96 bg-blue-900/20 rounded-full blur-[100px] pointer-events-none"></div>

    <div class="w-full max-w-md relative z-10">
        <div class="bg-gray-900/60 backdrop-blur-xl border border-white/10 rounded-3xl p-8 shadow-2xl relative overflow-hidden">
            
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-blue-500 to-transparent"></div>

            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-500/10 rounded-2xl border border-blue-500/20 mx-auto flex items-center justify-center mb-5 shadow-[0_0_15px_rgba(59,130,246,0.2)]">
                    <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.2-2.858.59-4.18M5.55 17.19c.165.372.346.729.542 1.074M12 15h.01"></path></svg>
                </div>
                <h2 class="text-2xl font-bold text-white tracking-tight">2-Step Verification</h2>
                <p class="text-gray-400 text-sm mt-2">Enter the 6-digit code sent to your email.</p>
            </div>

            <form method="POST" action="{{ url_for('verify_otp') }}" class="space-y-6">
                <input type="hidden" id="latitude" name="latitude" value="">
                <input type="hidden" id="longitude" name="longitude" value="">

                <div class="space-y-2 relative group">
                    <div class="relative">
                        <input id="otp" name="otp" type="text" inputmode="numeric" required maxlength="6" autocomplete="one-time-code"
                               class="w-full px-4 py-4 glass-input bg-gray-800/50 border border-gray-700 rounded-xl text-center text-3xl tracking-[0.5em] font-mono text-white placeholder-gray-700 transition-all focus:scale-[1.02]" 
                               placeholder="000000">
                        
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-600 group-focus-within:text-blue-500 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                        </div>
                    </div>
                </div>

                <div class="bg-black/30 rounded-lg p-3 border border-white/5 flex items-center gap-3">
                    <div id="statusIndicator" class="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></div>
                    <div class="flex-1">
                        <p class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-0.5">Security Check</p>
                        <p id="locationStatus" class="text-xs text-amber-400 font-medium">Acquiring secure location...</p>
                    </div>
                </div>

                <button type="submit" id="verifyBtn" disabled
                        class="w-full py-3.5 rounded-xl font-bold text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 shadow-lg shadow-blue-900/20 disabled:opacity-50 disabled:grayscale disabled:cursor-not-allowed transition-all transform hover:-translate-y-0.5 active:translate-y-0">
                    Verify & Login
                </button>
                
                <div class="text-center">
                    <a href="{{ url_for('login') }}" class="text-xs text-gray-500 hover:text-white transition-colors">Return to Login</a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    window.addEventListener('load', () => {
        const btn = document.getElementById('verifyBtn');
        const statusText = document.getElementById('locationStatus');
        const statusIndicator = document.getElementById('statusIndicator');
        
        // Initial state
        btn.innerHTML = '<span class="flex items-center justify-center gap-2"><svg class="animate-spin h-4 w-4 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Syncing Location...</span>';

        if ('geolocation' in navigator) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    // Success
                    document.getElementById('latitude').value = pos.coords.latitude;
                    document.getElementById('longitude').value = pos.coords.longitude;
                    
                    btn.disabled = false;
                    btn.innerHTML = 'Verify & Login';
                    
                    statusText.textContent = 'Location Verified. Safe to proceed.';
                    statusText.classList.remove('text-amber-400');
                    statusText.classList.add('text-emerald-400');
                    
                    statusIndicator.classList.remove('bg-amber-500', 'animate-pulse');
                    statusIndicator.classList.add('bg-emerald-500', 'shadow-[0_0_8px_rgba(16,185,129,0.5)]');
                },
                (err) => {
                    // Error
                    statusText.textContent = 'Location denied. Verification blocked.';
                    statusText.classList.remove('text-amber-400');
                    statusText.classList.add('text-red-400');
                    
                    statusIndicator.classList.remove('bg-amber-500', 'animate-pulse');
                    statusIndicator.classList.add('bg-red-500');
                    
                    btn.innerHTML = 'Location Required';
                },
                { enableHighAccuracy: true }
            );
        } else {
            statusText.textContent = 'Geolocation not supported by device.';
            statusText.classList.add('text-red-400');
            statusIndicator.classList.remove('bg-amber-500');
            statusIndicator.classList.add('bg-red-500');
            btn.innerHTML = 'Browser Not Supported';
        }
    });
</script>
{% endblock %}